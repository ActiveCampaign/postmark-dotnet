#!/usr/bin/env bash
set -e
shopt -s expand_aliases

pushd "$(dirname $0)"

popd

pushd "$( dirname "$0" )/../src/"

dotnet restore

#generate a version, based on the tag, or rev.
revision=$(git rev-parse HEAD)
inferred_assembly_version="0.0.${TRAVIS_BUILD_NUMBER:-0}.0"
version=${TRAVIS_TAG:-$inferred_assembly_version}
descriptive_version=${TRAVIS_TAG:-"$version-$revision"}

# build and test in one step.
dotnet test ./Postmark.Tests/Postmark.Tests.csproj /p:Configuration=Release /p:AssemblyVersion=$version /p:Version=$descriptive_version

if [[ $TRAVIS_TAG ]]; then
    echo 'TODO: This package should be published.'
else
    echo 'This package will not be published, because it has not been tagged.'
fi
popd